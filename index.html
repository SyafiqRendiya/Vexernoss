<!DOCTYPE html>
<html lang="id">
<head>
    <!-- Previous head content remains the same -->
    <!-- Add this new style for the comment system -->
    <style>
        /* Enhanced Comment System Styles */
        .comment {
            background: rgba(108, 92, 231, 0.05);
            border-left: 3px solid var(--primary);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .comment:hover {
            background: rgba(108, 92, 231, 0.1);
        }

        .comment.reply {
            margin-left: 40px;
            border-left-color: var(--accent);
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .comment.reply .comment-avatar {
            background: var(--accent);
        }

        .comment-author {
            font-weight: bold;
            color: var(--text-color);
            margin-right: 10px;
        }

        .comment-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .comment-content {
            color: var(--text-color);
            line-height: 1.6;
            padding-left: 55px;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            padding-left: 55px;
        }

        .comment-action {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 0.8rem;
            transition: color 0.3s ease;
            padding: 0;
        }

        .comment-action:hover {
            color: var(--primary);
        }

        .comment-reply:hover {
            color: var(--accent);
        }

        .comment-delete:hover {
            color: #ff4757;
        }

        .comment-edit-form {
            display: none;
            padding: 15px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }

        .comment-edit-form.active {
            display: block;
        }

        .comment-edit-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .reply-form {
            display: none;
            padding: 15px;
            background: rgba(253, 121, 168, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }

        .reply-form.active {
            display: block;
        }

        .replying-to {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .replying-to i {
            margin-right: 5px;
        }

        .comment-reply-form textarea {
            min-height: 100px;
        }

        .login-prompt {
            background: rgba(108, 92, 231, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .login-prompt p {
            margin-bottom: 15px;
        }

        .login-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .user-name {
            font-weight: bold;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .comment-count {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .comment-count i {
            margin-right: 10px;
        }

        .comment-loading {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .comment-loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(108, 92, 231, 0.2);
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .social-login {
            margin-top: 20px;
            text-align: center;
        }

        .social-login p {
            margin-bottom: 15px;
            position: relative;
        }

        .social-login p::before,
        .social-login p::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .social-login p::before {
            left: 0;
        }

        .social-login p::after {
            right: 0;
        }

        .social-login-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .social-login-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .social-login-btn.google {
            background: #DB4437;
        }

        .social-login-btn.facebook {
            background: #4267B2;
        }

        .social-login-btn.github {
            background: #333;
        }

        .social-login-btn:hover {
            transform: translateY(-3px);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--primary);
            cursor: pointer;
        }

        .forgot-password {
            text-align: right;
            margin-top: -15px;
            margin-bottom: 15px;
        }

        .forgot-password a {
            color: var(--accent);
            font-size: 0.8rem;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Previous HTML content remains the same until the comment section -->
    
    <!-- Comment Section -->
    <div class="comment-section fade-in delay-4">
        <h3>Komentar</h3>
        <p class="subtitle">Kami senang mendengar dari Anda</p>
        
        <div class="comment-count">
            <i class="fas fa-comments"></i>
            <span id="commentCounter">Memuat komentar...</span>
        </div>
        
        <!-- Login Prompt (shown when user is not logged in) -->
        <div class="login-prompt" id="loginPrompt">
            <p>Silakan masuk untuk meninggalkan komentar, membalas, atau mengedit komentar Anda.</p>
            <div class="login-buttons">
                <button class="btn" id="showLoginBtn">Masuk</button>
                <button class="btn btn-accent" id="showRegisterBtn">Daftar</button>
            </div>
        </div>
        
        <!-- User Badge (shown when user is logged in) -->
        <div class="user-badge" id="userBadge" style="display: none;">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-name" id="userName">Pengguna</div>
            <button class="logout-btn" id="logoutBtn">Keluar</button>
        </div>
        
        <div class="comments-list" id="commentsList">
            <div class="comment-loading">
                <i class="fas fa-spinner"></i>
                <p>Memuat komentar...</p>
            </div>
        </div>
        
        <!-- Comment Form -->
        <div class="comment-form" id="commentFormContainer">
            <h4>POST A COMMENT</h4>
            <form id="commentForm">
                <div class="form-group">
                    <textarea id="commentText" class="form-control" placeholder="Tulis komentar Anda di sini..." required></textarea>
                </div>
                <button type="submit" class="comment-submit">PUBLISH</button>
            </form>
            <div class="recaptcha-notice">
                This site is protected by reCAPTCHA and the Google 
                <a href="https://policies.google.com/privacy" target="_blank">privacy policy</a> and 
                <a href="https://policies.google.com/terms" target="_blank">Terms of Service</a> apply.
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3 class="modal-title" id="modalTitle">Masuk ke Akun Anda</h3>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Masuk</div>
                <div class="auth-tab" id="registerTab">Daftar</div>
            </div>
            
            <!-- Login Form -->
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-control" placeholder="Email Anda" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-control" placeholder="Password Anda" required>
                </div>
                <div class="forgot-password">
                    <a href="#" id="forgotPassword">Lupa password?</a>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Masuk</button>
                
                <div class="social-login">
                    <p>Atau masuk dengan</p>
                    <div class="social-login-buttons">
                        <button type="button" class="social-login-btn google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button type="button" class="social-login-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button type="button" class="social-login-btn github">
                            <i class="fab fa-github"></i>
                        </button>
                    </div>
                </div>
                
                <div class="auth-switch">
                    Belum punya akun? <a id="switchToRegister">Daftar sekarang</a>
                </div>
            </form>
            
            <!-- Register Form -->
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <input type="text" id="registerName" class="form-control" placeholder="Nama Anda" required>
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" class="form-control" placeholder="Email Anda" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" class="form-control" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Konfirmasi Password" required>
                </div>
                <button type="submit" class="btn btn-accent" style="width: 100%;">Daftar</button>
                
                <div class="social-login">
                    <p>Atau daftar dengan</p>
                    <div class="social-login-buttons">
                        <button type="button" class="social-login-btn google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button type="button" class="social-login-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button type="button" class="social-login-btn github">
                            <i class="fab fa-github"></i>
                        </button>
                    </div>
                </div>
                
                <div class="auth-switch">
                    Sudah punya akun? <a id="switchToLogin">Masuk sekarang</a>
                </div>
            </form>
            
            <!-- Forgot Password Form -->
            <form class="auth-form" id="forgotPasswordForm">
                <div class="form-group">
                    <input type="email" id="forgotEmail" class="form-control" placeholder="Email Anda" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Kirim Link Reset</button>
                
                <div class="auth-switch">
                    <a id="switchToLoginFromForgot">Kembali ke halaman masuk</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Previous footer content remains the same -->

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZ2nQw9HXq6X9Q9Q9Q9Q9Q9Q9Q9Q9Q9Q",
            authDomain: "vexernoss-comments.firebaseapp.com",
            projectId: "vexernoss-comments",
            storageBucket: "vexernoss-comments.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnopqrstuv"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Comment System
        let currentUser = null;
        let comments = [];
        let editTimeout = 60 * 60 * 1000; // 60 minutes in milliseconds

        // DOM Elements
        const commentsList = document.getElementById('commentsList');
        const commentForm = document.getElementById('commentForm');
        const commentText = document.getElementById('commentText');
        const loginPrompt = document.getElementById('loginPrompt');
        const userBadge = document.getElementById('userBadge');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const commentCounter = document.getElementById('commentCounter');
        
        // Auth Modal Elements
        const authModal = document.getElementById('authModal');
        const closeModal = document.getElementById('closeModal');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');
        const forgotPassword = document.getElementById('forgotPassword');
        const switchToLoginFromForgot = document.getElementById('switchToLoginFromForgot');
        const modalTitle = document.getElementById('modalTitle');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase auth state listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    updateUserUI();
                    loadComments();
                } else {
                    // User is signed out
                    currentUser = null;
                    updateUserUI();
                    loadComments();
                }
            });

            // Event listeners
            commentForm.addEventListener('submit', handleCommentSubmit);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Auth modal events
            showLoginBtn.addEventListener('click', () => showAuthModal('login'));
            showRegisterBtn.addEventListener('click', () => showAuthModal('register'));
            closeModal.addEventListener('click', hideAuthModal);
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));
            switchToRegister.addEventListener('click', () => switchAuthTab('register'));
            switchToLogin.addEventListener('click', () => switchAuthTab('login'));
            forgotPassword.addEventListener('click', () => switchAuthTab('forgot'));
            switchToLoginFromForgot.addEventListener('click', () => switchAuthTab('login'));
            
            // Auth form submissions
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            
            // Load comments initially
            loadComments();
        });

        // Update UI based on auth state
        function updateUserUI() {
            if (currentUser) {
                loginPrompt.style.display = 'none';
                userBadge.style.display = 'flex';
                userName.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                userAvatar.textContent = (currentUser.displayName || currentUser.email[0]).toUpperCase();
                commentFormContainer.style.display = 'block';
            } else {
                loginPrompt.style.display = 'block';
                userBadge.style.display = 'none';
                commentFormContainer.style.display = 'none';
            }
        }

        // Show auth modal
        function showAuthModal(tab = 'login') {
            authModal.classList.add('active');
            switchAuthTab(tab);
        }

        // Hide auth modal
        function hideAuthModal() {
            authModal.classList.remove('active');
        }

        // Switch between login/register/forgot tabs
        function switchAuthTab(tab) {
            // Reset forms
            loginForm.reset();
            registerForm.reset();
            forgotPasswordForm.reset();
            
            // Update active tabs
            loginTab.classList.remove('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            forgotPasswordForm.classList.remove('active');
            
            switch(tab) {
                case 'login':
                    modalTitle.textContent = 'Masuk ke Akun Anda';
                    loginTab.classList.add('active');
                    loginForm.classList.add('active');
                    break;
                case 'register':
                    modalTitle.textContent = 'Buat Akun Baru';
                    registerTab.classList.add('active');
                    registerForm.classList.add('active');
                    break;
                case 'forgot':
                    modalTitle.textContent = 'Lupa Password';
                    forgotPasswordForm.classList.add('active');
                    break;
            }
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showNotification('Berhasil masuk!', true);
                    hideAuthModal();
                })
                .catch(error => {
                    showNotification(error.message, false);
                });
        }

        // Handle register
        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showNotification('Password tidak cocok!', false);
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Update user profile with name
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    showNotification('Akun berhasil dibuat!', true);
                    hideAuthModal();
                })
                .catch(error => {
                    showNotification(error.message, false);
                });
        }

        // Handle forgot password
        function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Link reset password telah dikirim ke email Anda', true);
                    switchAuthTab('login');
                })
                .catch(error => {
                    showNotification(error.message, false);
                });
        }

        // Handle logout
        function handleLogout() {
            auth.signOut()
                .then(() => {
                    showNotification('Anda telah keluar', true);
                })
                .catch(error => {
                    showNotification(error.message, false);
                });
        }

        // Load comments from Firestore
        function loadComments() {
            commentsList.innerHTML = '<div class="comment-loading"><i class="fas fa-spinner"></i><p>Memuat komentar...</p></div>';
            
            db.collection('comments')
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    comments = [];
                    querySnapshot.forEach(doc => {
                        comments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    renderComments();
                    updateCommentCount();
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    commentsList.innerHTML = '<div class="comment-loading"><i class="fas fa-exclamation-triangle"></i><p>Gagal memuat komentar. Silakan refresh halaman.</p></div>';
                });
        }

        // Real-time comment updates
        function setupRealTimeUpdates() {
            db.collection('comments')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    const changes = snapshot.docChanges();
                    
                    changes.forEach(change => {
                        if (change.type === 'added') {
                            // New comment added
                            const newComment = {
                                id: change.doc.id,
                                ...change.doc.data()
                            };
                            
                            // Check if comment already exists
                            if (!comments.some(c => c.id === newComment.id)) {
                                comments.unshift(newComment);
                                renderComments();
                                updateCommentCount();
                            }
                        } else if (change.type === 'modified') {
                            // Comment updated
                            const updatedComment = {
                                id: change.doc.id,
                                ...change.doc.data()
                            };
                            
                            const index = comments.findIndex(c => c.id === updatedComment.id);
                            if (index !== -1) {
                                comments[index] = updatedComment;
                                renderComments();
                            }
                        } else if (change.type === 'removed') {
                            // Comment deleted
                            const deletedId = change.doc.id;
                            comments = comments.filter(c => c.id !== deletedId);
                            renderComments();
                            updateCommentCount();
                        }
                    });
                }, error => {
                    console.error('Error in real-time updates:', error);
                });
        }

        // Render comments to the DOM
        function renderComments() {
            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="comment-loading"><i class="fas fa-comment-slash"></i><p>Belum ada komentar. Jadilah yang pertama berkomentar!</p></div>';
                return;
            }
            
            let html = '';
            
            // Add admin comment first
            html += `
                <div class="comment" data-id="admin-comment">
                    <div class="comment-header">
                        <div class="comment-avatar">A</div>
                        <div class="comment-author">Admin Bejir</div>
                        <div class="comment-date">9/4/2023, 6:40:20 AM</div>
                    </div>
                    <div class="comment-content">Halo semuanya, terima kasih telah menggunakan jasa kami, kami sangat berterima kasih dengan kalian, jika ada yang ingin di tanyakan jangan ragu bertanya ya.</div>
                </div>
            `;
            
            // Add user comments
            comments.forEach(comment => {
                const commentDate = comment.timestamp ? comment.timestamp.toDate().toLocaleString() : new Date().toLocaleString();
                const isEditable = currentUser && 
                                 (currentUser.uid === comment.userId) && 
                                 (new Date() - comment.timestamp.toDate() < editTimeout);
                
                html += `
                    <div class="comment${comment.parentId ? ' reply' : ''}" data-id="${comment.id}">
                        <div class="comment-header">
                            <div class="comment-avatar">${comment.userName ? comment.userName.charAt(0).toUpperCase() : 'U'}</div>
                            <div class="comment-author">${comment.userName || 'Pengguna'}</div>
                            <div class="comment-date">${commentDate}</div>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-actions">
                            <button class="comment-action comment-reply" data-id="${comment.id}">
                                <i class="fas fa-reply"></i> Balas
                            </button>
                            ${currentUser && currentUser.uid === comment.userId ? `
                                ${isEditable ? `
                                    <button class="comment-action comment-edit" data-id="${comment.id}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                ` : ''}
                                <button class="comment-action comment-delete" data-id="${comment.id}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- Edit Form (hidden by default) -->
                        <div class="comment-edit-form" id="edit-form-${comment.id}">
                            <textarea class="form-control" id="edit-text-${comment.id}" required>${comment.content}</textarea>
                            <div class="comment-edit-buttons">
                                <button class="btn" id="save-edit-${comment.id}">Simpan</button>
                                <button class="btn btn-accent" id="cancel-edit-${comment.id}">Batal</button>
                            </div>
                        </div>
                        
                        <!-- Reply Form (hidden by default) -->
                        <div class="reply-form" id="reply-form-${comment.id}">
                            <div class="replying-to">
                                <i class="fas fa-reply"></i>
                                Membalas ${comment.userName || 'Pengguna'}
                            </div>
                            <textarea class="form-control" id="reply-text-${comment.id}" placeholder="Tulis balasan Anda..." required></textarea>
                            <div class="comment-edit-buttons">
                                <button class="btn" id="submit-reply-${comment.id}">Kirim</button>
                                <button class="btn btn-accent" id="cancel-reply-${comment.id}">Batal</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            commentsList.innerHTML = html;
            
            // Attach event listeners to all action buttons
            document.querySelectorAll('.comment-reply').forEach(btn => {
                btn.addEventListener('click', () => showReplyForm(btn.dataset.id));
            });
            
            document.querySelectorAll('.comment-edit').forEach(btn => {
                btn.addEventListener('click', () => showEditForm(btn.dataset.id));
            });
            
            document.querySelectorAll('.comment-delete').forEach(btn => {
                btn.addEventListener('click', () => deleteComment(btn.dataset.id));
            });
            
            document.querySelectorAll('[id^="cancel-edit-"]').forEach(btn => {
                const commentId = btn.id.replace('cancel-edit-', '');
                btn.addEventListener('click', () => hideEditForm(commentId));
            });
            
            document.querySelectorAll('[id^="save-edit-"]').forEach(btn => {
                const commentId = btn.id.replace('save-edit-', '');
                btn.addEventListener('click', () => saveEdit(commentId));
            });
            
            document.querySelectorAll('[id^="cancel-reply-"]').forEach(btn => {
                const commentId = btn.id.replace('cancel-reply-', '');
                btn.addEventListener('click', () => hideReplyForm(commentId));
            });
            
            document.querySelectorAll('[id^="submit-reply-"]').forEach(btn => {
                const commentId = btn.id.replace('submit-reply-', '');
                btn.addEventListener('click', () => submitReply(commentId));
            });
        }

        // Update comment count
        function updateCommentCount() {
            const count = comments.length;
            commentCounter.textContent = count === 0 ? 'Belum ada komentar' : 
                                        count === 1 ? '1 Komentar' : 
                                        `${count} Komentar`;
        }

        // Handle new comment submission
        function handleCommentSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showNotification('Silakan masuk untuk berkomentar', false);
                showAuthModal('login');
                return;
            }
            
            const content = commentText.value.trim();
            if (!content) {
                showNotification('Komentar tidak boleh kosong', false);
                return;
            }
            
            const newComment = {
                content: content,
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                userEmail: currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                parentId: null // This is a top-level comment
            };
            
            db.collection('comments').add(newComment)
                .then(() => {
                    commentText.value = '';
                    showNotification('Komentar berhasil diposting!', true);
                })
                .catch(error => {
                    console.error('Error adding comment:', error);
                    showNotification('Gagal memposting komentar', false);
                });
        }

        // Show edit form for a comment
        function showEditForm(commentId) {
            document.getElementById(`edit-form-${commentId}`).classList.add('active');
        }

        // Hide edit form
        function hideEditForm(commentId) {
            document.getElementById(`edit-form-${commentId}`).classList.remove('active');
        }

        // Save edited comment
        function saveEdit(commentId) {
            const newContent = document.getElementById(`edit-text-${commentId}`).value.trim();
            
            if (!newContent) {
                showNotification('Komentar tidak boleh kosong', false);
                return;
            }
            
            db.collection('comments').doc(commentId).update({
                content: newContent,
                edited: true,
                editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                hideEditForm(commentId);
                showNotification('Komentar berhasil diperbarui', true);
            })
            .catch(error => {
                console.error('Error updating comment:', error);
                showNotification('Gagal memperbarui komentar', false);
            });
        }

        // Show reply form
        function showReplyForm(commentId) {
            if (!currentUser) {
                showNotification('Silakan masuk untuk membalas komentar', false);
                showAuthModal('login');
                return;
            }
            
            document.getElementById(`reply-form-${commentId}`).classList.add('active');
            document.getElementById(`reply-text-${commentId}`).focus();
        }

        // Hide reply form
        function hideReplyForm(commentId) {
            document.getElementById(`reply-form-${commentId}`).classList.remove('active');
            document.getElementById(`reply-text-${commentId}`).value = '';
        }

        // Submit reply
        function submitReply(commentId) {
            const content = document.getElementById(`reply-text-${commentId}`).value.trim();
            
            if (!content) {
                showNotification('Balasan tidak boleh kosong', false);
                return;
            }
            
            const parentComment = comments.find(c => c.id === commentId);
            
            const reply = {
                content: content,
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                userEmail: currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                parentId: commentId,
                parentUserName: parentComment.userName || 'Pengguna'
            };
            
            db.collection('comments').add(reply)
                .then(() => {
                    hideReplyForm(commentId);
                    showNotification('Balasan berhasil diposting!', true);
                })
                .catch(error => {
                    console.error('Error adding reply:', error);
                    showNotification('Gagal memposting balasan', false);
                });
        }

        // Delete comment
        function deleteComment(commentId) {
            if (!confirm('Apakah Anda yakin ingin menghapus komentar ini?')) {
                return;
            }
            
            db.collection('comments').doc(commentId).delete()
                .then(() => {
                    showNotification('Komentar berhasil dihapus', true);
                })
                .catch(error => {
                    console.error('Error deleting comment:', error);
                    showNotification('Gagal menghapus komentar', false);
                });
        }

        // Show notification
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.innerHTML = `
                <i class="fas fa-${isSuccess ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('active');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('active');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // Start real-time updates after initial load
        setTimeout(() => {
            setupRealTimeUpdates();
        }, 1000);

        // Previous JavaScript code remains the same
    </script>
</body>
</html>
